<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<title>Concepts</title>
<link rel="stylesheet" href="css/site.css">
<script src="js/setup.js"></script><script defer src="js/site.js"></script>

</head>
<body class="article"><div id="banner-container" class="container" role="banner">
  <div id="banner" class="contained" role="banner">
    <div id="switch-theme">
      <input type="checkbox" id="switch-theme-checkbox" />
      <label for="switch-theme-checkbox">Dark Theme</label>
    </div>
  </div>
</div>
<div id="tocbar-container" class="container" role="navigation">
  <div id="tocbar" class="contained" role="navigation">
    <button id="toggle-toc"></button>
  </div>
</div>
<div id="main-container" class="container">
  <div id="main" class="contained">
    <div id="doc" class="doc">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_concepts"><a class="anchor" href="#_concepts"></a>Concepts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SBM offers commands to scan application source code and run recipes against it.
Recipes bundle actions to apply source code migrations or find information in the codebase.</p>
</div>
<div class="paragraph">
<p>An <code>Action</code> is a single step in a recipe and can be reused by other recipes.
Every <code>Recipe</code> has at least one <code>Action</code> and each Recipe and every action has a condition which defines if the recipe and/or it&#8217;s actions are applicable.</p>
</div>
<div class="paragraph">
<p>The condition has access to all resources to evaluate to <code>true</code> or <code>false</code>.
If a recipe&#8217;s condition evaluates to <code>false</code> the recipe is not displayed.
Actions with a condition evaluating to <code>true</code> are applicable and will be executed with the recipe.
When all actions of a recipe evaluate to <code>false</code> the recipe itself is not applicable.</p>
</div>
<div class="sect2">
<h3 id="_recipes"><a class="anchor" href="#_recipes"></a>Recipes</h3>
<div class="paragraph">
<p>Recipes can be declared in yaml syntax or provided as Java bean definitions.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>See <a href="{repo}/blob/main/components/sbm-support-boot/src/main/resources/recipes/initialize-spring-boot-migration.yaml" target="_blank" rel="noopener">initialize-spring-boot-migration.yaml</a> for a recipe in YAML syntax</p>
</li>
<li>
<p>See <a href="{repo}/blob/main/components/sbm-recipes-mule-to-boot/src/main/java/org/springframework/sbm/mule/MigrateMuleToBoot.java" target="_blank" rel="noopener">MigrateMuleToBoot.java</a> for a recipe as Spring bean.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_actions"><a class="anchor" href="#_actions"></a>Actions</h3>
<div class="paragraph">
<p>Action is the starting point when developing a recipe.
Every Action has access to all resources and their ASTs through the <code>ProjectContext</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class MyAction extends AbstractAction {
    void apply(ProjectContext context) {
        // analyse and modify AST
    }
}
</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_projectcontext"><a class="anchor" href="#_projectcontext"></a>ProjectContext</h3>
<div class="paragraph">
<p>After scanning and parsing the source code of a given application a <code>ProjectContext</code> gets created.
The <code>ProjectContext</code> acts as facade to the <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">abstract syntax tree</a> (AST) of the project and provides an API to access project resources.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ProjectJavaSources pjs = context.getProjectJavaSources();
ApplicationModules am = context.getApplicationModules()
</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ProjectContext</code> represents the current application state in memory and provides access to all resources.
The API provides methods to retrieve and modify Java source, application modules and build files.
All other resource types can be retrieved using finders.</p>
</div>
</div>
<div class="sect2">
<h3 id="Finders"><a class="anchor" href="#Finders"></a>Finders</h3>
<div class="paragraph">
<p>Finders are useful to access and filter resources.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface ProjectResourceFinder&lt;T&gt; {
    T apply(ProjectResourceSet projectResourceSet);
}
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finder have access to the <code>ProjectResourceSet</code> (see <a href="#ProjectResourceSet">[ProjectResourceSet]</a>) to filter/find resources and return the result.
The result is of the same type as the generic type <code>T</code>.</p>
</div>
<div class="paragraph">
<p>The ProjectContext provides a <code>search(..)</code> method to apply Finder.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">List&lt;..&gt; resources = projectContext.search(new PathMatchingProjectResourceFinder("...
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finders also provide access to specialized resources, resources that are not directly accessible through the ProjectContext Api.
Specialized resources like <code>SpringBootApplicationProperties</code>, <code>PersistenceXml</code>, <code>WebXml</code>, &#8230;&#8203;, can be retrieved by their <code>Finder</code>s.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">void apply(ProjectContext context) {
    SpringBootApplicationProperties p = context.search(new SpringBootApplicationPropertiesFinder());
    p.getProperty("cloud-profile", "some.property.key")
}
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read the <a href="#Specialized_Resources">Specialized Resources</a> section to learn how you can provide new Specialized Resources.</p>
</div>
</div>
<div class="sect2">
<h3 id="_multi_module_projects"><a class="anchor" href="#_multi_module_projects"></a>Multi module projects</h3>

</div>
<div class="sect2">
<h3 id="_application_lifecycle"><a class="anchor" href="#_application_lifecycle"></a>Application Lifecycle</h3>
<div class="sect3">
<h4 id="_scan_application"><a class="anchor" href="#_scan_application"></a>Scan Application</h4>
<div class="paragraph">
<p>The user provides a root directory to scan a project.
After scanning the given directory a set of preconditions is checked to verify that the scanned project can be successfully parsed.
See <a href="#Check Preconditions">[Check Preconditions]</a> to learn how you can provide additional precondition checks.</p>
</div>
<div class="sect4">
<h5 id="_parsing"><a class="anchor" href="#_parsing"></a>Parsing</h5>
<div class="paragraph">
<p>When all preconditions are met the project resources are parsed and the abstract syntax tree (AST) gets created in memory.</p>
</div>
</div>
<div class="sect4">
<h5 id="_specialized_resources"><a class="anchor" href="#_specialized_resources"></a>Specialized Resources</h5>
<div class="paragraph">
<p>After parsing the project resources a set of <code>ProjectResourceWrapper</code>s is called and generic resources can be replaced
with more specialized resources providing a specialized API for these resources.
Think of replacing a generic XML file representing <code>persistence.xml</code> (JPA deployment descriptor) with a specialized
resource representation offering an API to act on a specialized "JPA deployment descriptor".
See <a href="#_specialized_resources">Specialized Resources</a> to learn how yo can provide specialized resources.</p>
</div>
</div>
<div class="sect4">
<h5 id="_creating_the_projectcontext"><a class="anchor" href="#_creating_the_projectcontext"></a>Creating the ProjectContext</h5>
<div class="paragraph">
<p>After replacing specialized resources the ProjectContext gets created.</p>
</div>
</div>
<div class="sect4">
<h5 id="_display_applicable_recipes"><a class="anchor" href="#_display_applicable_recipes"></a>Display Applicable Recipes</h5>
<div class="paragraph">
<p>With the <code>ProjectContext</code> in place SBM checks all <code>Condition</code>s of recipes and their <code>Action</code>s to find applicable recipes.
The resulting list of applicable recipes is then shown to the user to select and apply recipes against the scanned application.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_apply_recipe"><a class="anchor" href="#_apply_recipe"></a>Apply Recipe</h4>
<div class="paragraph">
<p>The user applies a recipe from the list of applicable recipes.</p>
</div>
<div class="sect4">
<h5 id="_applying_recipe_actions"><a class="anchor" href="#_applying_recipe_actions"></a>Applying Recipe Actions</h5>
<div class="paragraph">
<p>SBM provides the <code>ProjectContext</code> to the list of applicable <code>Action</code>s and each <code>Action</code> modifies the AST through the
<code>ProjectContext</code> API. These modifications are only represented in memory.</p>
</div>
</div>
<div class="sect4">
<h5 id="_verify_application_in_sync"><a class="anchor" href="#_verify_application_in_sync"></a>Verify Application In Sync</h5>
<div class="paragraph">
<p>After applying all <code>Action</code>s of the <code>Recipe</code> the changes need to be written back to filesystem.
When <code>sbm.gitSupportEnabled</code> is <code>true</code> SBM verifies that nothing changed in the scanned project while the recipe was applied.
If the git hash changed or non-indexed resources are found the changes are rolled back, the project must be synced,
re-scanned and the recipe needs to be re-applied.</p>
</div>
</div>
<div class="sect4">
<h5 id="_writing_back_changes"><a class="anchor" href="#_writing_back_changes"></a>Writing Back Changes</h5>
<div class="paragraph">
<p>When git support is disabled or the project is in sync the in-memory representation is written back to the file system.</p>
</div>
</div>
<div class="sect4">
<h5 id="_commit_changes"><a class="anchor" href="#_commit_changes"></a>Commit Changes</h5>
<div class="paragraph">
<p>When git support is enabled SBM commits the changes applied by running the recipe and the next recipe can be applied.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_modules"><a class="anchor" href="#_modules"></a>Modules</h3>
<div class="paragraph">
<p>Since 0.9.0 SBM starts to support <a href="https://maven.apache.org/guides/mini/guide-multiple-modules.html#the-reactor">multi module applications</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_spring_boot_resources"><a class="anchor" href="#_spring_boot_resources"></a>Spring Boot Resources</h3>
<div class="sect3">
<h4 id="_spring_restcontroller_bean"><a class="anchor" href="#_spring_restcontroller_bean"></a>Spring RestController Bean</h4>
<div class="paragraph">
<p>Classes annotated with Spring <code>@RestController</code> annotation can be found using the <code>FindRestControllerBeans</code> finder.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">List&lt;RestControllerBean&gt; restController = projectContext.search(new FindRestControllerBeans());

List&lt;RestMethod&gt; restMethods = restController.get(0).getRestMethods();

restMethods.get(0).
</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-03-07 11:09:31 +0700
</div>
</div>
</div>
  </div>
</div>
</body>
</html>