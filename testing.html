<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<title>Testing</title>
<link rel="stylesheet" href="css/site.css">
<script src="js/setup.js"></script><script defer src="js/site.js"></script>

</head>
<body class="article"><div id="banner-container" class="container" role="banner">
  <div id="banner" class="contained" role="banner">
    <div id="switch-theme">
      <input type="checkbox" id="switch-theme-checkbox" />
      <label for="switch-theme-checkbox">Dark Theme</label>
    </div>
  </div>
</div>
<div id="tocbar-container" class="container" role="navigation">
  <div id="tocbar" class="contained" role="navigation">
    <button id="toggle-toc"></button>
  </div>
</div>
<div id="main-container" class="container">
  <div id="main" class="contained">
    <div id="doc" class="doc">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_testing"><a class="anchor" href="#_testing"></a>Testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Different classes exist to help writing tests for <code>Recipe</code>s, <code>Condition</code>s and <code>Action</code>s.</p>
</div>
<div class="sect2">
<h3 id="_windows_linux"><a class="anchor" href="#_windows_linux"></a>Windows &amp; Linux</h3>
<div class="paragraph">
<p>Linebreaks, encoding and path separator do (most probably will) differ depending on the OS the tests and the application
is executed on.</p>
</div>
<div class="paragraph">
<p>To make the tests and application run on Windows, Linux and OSX you must take precautions in some cases.</p>
</div>
<div class="sect3">
<h4 id="_ignoring_line_separator_in_assertions"><a class="anchor" href="#_ignoring_line_separator_in_assertions"></a>Ignoring Line separator in assertions</h4>

</div>
</div>
<div class="sect2">
<h3 id="_testprojectcontext"><a class="anchor" href="#_testprojectcontext"></a>TestProjectContext</h3>
<div class="paragraph">
<p>When testing <code>Action</code>s and <code>Condition</code>s you&#8217;ll need a initialized ProjectContext as test fixture.
To avoid reading projects for testing from the filesystem the <code>TestProjectContext</code> can be used.</p>
</div>
<div class="paragraph">
<p>The <code>TestProjectContext</code> offers ways to create all kinds of ProjectContext instances initialized from resorces given as
strings as if they were read from filesystem. Have a look at the API documentation for details.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creates different pom.xml. A blank default, with given dependencies defined, from a given String or as Mockito mock</p>
</li>
<li>
<p>Provides a method to register additional ResourceWrapper for specialized resources</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String sourceCode = "package com.acme.app;\npublic class MyClass {}";

ProjectContext projectContext = TestProjectContext.buildProjectContext() <i class="conum" data-value="1"></i><b>(1)</b>
        .withBuildFileHavingDependencies("org.junit.jupiter:junit-jupiter-api:5.7.0") <i class="conum" data-value="2"></i><b>(2)</b>
        .withJavaSources(sourceCode) <i class="conum" data-value="3"></i><b>(3)</b>
        .build(); <i class="conum" data-value="4"></i><b>(4)</b>

// Use ProjectContext to test Action or Condition
</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call TestProjectContext static builder method which will inject a mock for ApplicationEventPublisher</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add required dependencies to the classpath (assume they&#8217;re needed). This will add a pom.xml declaring the provided dependencies.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add a new Java file with given source to <code>src/main/java/com/acme/app/MyClass.java</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>build and return the initialized ProjectContext.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_projectcontextfilesystemtestsupport"><a class="anchor" href="#_projectcontextfilesystemtestsupport"></a>ProjectContextFileSystemTestSupport</h3>
<div class="paragraph">
<p>If you want to create a ProjectContext from filesystem, <code>ProjectContextFileSystemTestSupport</code> is your friend.<br>
It assumes a directory <code>testcode</code> in the same module as the test resides in.
The initial project is read from a <code>given</code> directory inside <code>testcode</code>, let&#8217;s say <code>testcode/given/my-project</code>.
The resources are then copied to <code>target/test-projects/my-project</code> and the ProjectContext is created from this directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Test
void someTest() {
    ProjectContext projectContext = ProjectContextFileSystemTestSupport
                                            .createProjectContextFromDir("boot-23-app");
    // modify ProjectContext
}
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copies all resources from <code>./testcode/given/boot-23-app</code> to <code>./target/test-projects/boot-23-app</code> and creates a ProjectContext from it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_recipeintegrationtestsupport"><a class="anchor" href="#_recipeintegrationtestsupport"></a>RecipeIntegrationTestSupport</h3>
<div class="paragraph">
<p>If you want to integration test a recipe against a project read from filesystem, <code>RecipeIntegrationTestSupport</code> can help you.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String applicationDir = "example-app"; <i class="conum" data-value="1"></i><b>(1)</b>

RecipeIntegrationTestSupport.initializeProject(applicationDir)
        .andApplyRecipe("boot-2.4-2.5-datasource-initializer"); <i class="conum" data-value="2"></i><b>(2)</b>

Path javaClass = RecipeIntegrationTestSupport.getResultDir(applicationDir).resolve("src/main/java/com/example/SomeJavaClass.java"); <i class="conum" data-value="3"></i><b>(3)</b>

assertThat(javaClass).hasContent("..."); <i class="conum" data-value="4"></i><b>(4)</b>
</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Provide a project, here under <code>./testcode/example-app/given</code>.
This project will be copied to a clean dir <code>target/test-projects/example-app</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Scan the copied project and apply the given recipe against it</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retrieve the path to a resource after migration</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Verify the resource has expected content</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_integrationtestbaseclass"><a class="anchor" href="#_integrationtestbaseclass"></a>IntegrationTestBaseClass</h3>
<div class="paragraph">
<p>For end-to-end tests using the shell commands <code>IntegrationTestBaseClass</code> will be helpful.<br>
These are the most complete tests but also the slowest.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently these tests reside in <code>spring-shell</code> module.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class MyFullBlownIntegrationTest extends IntegrationTestBaseClass {
    @Override
    protected String getTestSubDir() { <i class="conum" data-value="1"></i><b>(1)</b>
        return "some-dir/project-dir"; <i class="conum" data-value="2"></i><b>(2)</b>
    }

    @Test
    @Tag("integration")
    void migrateSomethingToSpringBoot() {
        initializeTestProject(); <i class="conum" data-value="3"></i><b>(3)</b>
        scanProject(); <i class="conum" data-value="4"></i><b>(4)</b>
        applyRecipe("initialize-spring-boot-migration"); <i class="conum" data-value="5"></i><b>(5)</b>
        applyRecipe("migrate-x-to-boot"); <i class="conum" data-value="6"></i><b>(6)</b>
        // simulate manual step
        replaceFile( <i class="conum" data-value="7"></i><b>(7)</b>
                getTestDir().resolve("src/test/java/com/example/jee/app/PersonServiceTest.java"),
                getTestDir().resolve("manual-step/BootifiedPersonServiceTest.java")
        );
        String localBusinessInterface = loadJavaFile("com.example.jee.app.ejb.local", "ABusinessInterface"); <i class="conum" data-value="8"></i><b>(8)</b>
        // verify @Local was removed
        assertThat(localBusinessInterface).doesNotContain("@Local"); <i class="conum" data-value="9"></i><b>(9)</b>
        executeMavenGoals(getTestDir(), "clean", "package", "spring-boot:build-image"); <i class="conum" data-value="10"></i><b>(10)</b>
        int port = startDockerContainer("jee-app:8.0.5-SNAPSHOT", 8080); <i class="conum" data-value="11"></i><b>(11)</b>
        TestRestTemplate testRestTemplate = new TestRestTemplate(); <i class="conum" data-value="12"></i><b>(12)</b>
        // Test Servlet
        String response = testRestTemplate.getForObject("http://localhost:" + port + "/HelloWorld", String.class); <i class="conum" data-value="13"></i><b>(13)</b>
        assertThat(response).isEqualTo("Hello World!"); <i class="conum" data-value="14"></i><b>(14)</b>
    }
}
</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>getTestSubDir()</code> method must be implemented.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It must return the path to the test project in <code>src/test/resources</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Copies test project from <code>src/test/resources/some-dir/project-dir</code> to <code>target/sbm-integration-test/some-dir/project-dir</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Scans the copied test project, same as calling <code>scan</code> in CLI</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Apply the recipe <code>initialize-spring-boot-migration</code>, same as calling <code>apply initialize-spring-boot-migration</code> in CLI.
Changes will be reflected in the filesystem after this call.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Apply another recipe <code>migrate-x-to-boot</code></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Replace a file, here because the Test needs to be migrated manually</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Load the content a Java file as String</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Assertions about the context of the Java file</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Call <code>mvn clean package spring-boot:build-image</code> in the test project</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Start the docker image from the last step containing the migrated Spring application</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Create a RestTemplate</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>Use the RestTemplate to retrive some data from the migrated Spring application running in Docker</td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td>Verify the response</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-11-15 06:05:11 +0700
</div>
</div>
</div>
  </div>
</div>
</body>
</html>