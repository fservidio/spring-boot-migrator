<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<title>How To</title>
<link rel="stylesheet" href="css/site.css">
<script src="js/setup.js"></script><script defer src="js/site.js"></script>

</head>
<body class="article"><div id="banner-container" class="container" role="banner">
  <div id="banner" class="contained" role="banner">
    <div id="switch-theme">
      <input type="checkbox" id="switch-theme-checkbox" />
      <label for="switch-theme-checkbox">Dark Theme</label>
    </div>
  </div>
</div>
<div id="tocbar-container" class="container" role="navigation">
  <div id="tocbar" class="contained" role="navigation">
    <button id="toggle-toc"></button>
  </div>
</div>
<div id="main-container" class="container">
  <div id="main" class="contained">
    <div id="doc" class="doc">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_how_to"><a class="anchor" href="#_how_to"></a>How To</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_check_preconditions"><a class="anchor" href="#_check_preconditions"></a>Check Preconditions</h3>
<div class="paragraph">
<p>Preconditions that must be met to allow a successful migration can be checked before scanning an application.
This allows a user to be informed about unmet preconditions that would prevent a successful migration before the
sometimes lengthy parsing is done.</p>
</div>
<div class="paragraph">
<p>To add a new precondition check you need to provide a component extending abstract <code>PreconditionCheck</code> class
and return the result of the precondition check as <code>PreconditionCheckResult</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Component
public class MyPreconditionCheck extends PreconditionCheck {
    @Override
    public PreconditionCheckResult verify(Path projectRoot, List&lt;Resource&gt; projectResources) {
        // verify precondition is met...
    }
}
</code></pre>
</div>
</div>
<div class="paragraph">
<p>This class must be placed under <code>org.springframework.sbm</code> to be picked up by component scan and gets executed after scanning
the project but before parsing resources into an AST.
If one of the preconditions fails (<code>ResultState.WARN</code> or <code>ResultState.FAILED</code>), the scan is interrupted and a message is
shown to the user.</p>
</div>
</div>
<div class="sect2">
<h3 id="_implement_actions"><a class="anchor" href="#_implement_actions"></a>Implement Actions</h3>
<div class="paragraph">
<p>First step on your journey to implement a new recipe will be the implementation of an <code>Action</code>.
Every Action that needs access to the ProjectContext to modify resources should extend <code>AbstractAction</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class MyAction extends AbstractAction {
    void apply(ProjectContext context) {
        // analyse and modify AST
    }
}
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use <a href="#TestProjectContext">[TestProjectContext]</a> to test your Action.</p>
</div>
<div class="sect3">
<h4 id="_display_progress"><a class="anchor" href="#_display_progress"></a>Display Progress</h4>
<div class="paragraph">
<p>A long running action can leave the user without any information about the progress of the migration.</p>
</div>
<div class="paragraph">
<p>The <code>Action</code> interface defines methods to display progress information to the user.
There are two types of rendered information, process and log messages.</p>
</div>
<div class="sect4">
<h5 id="_process"><a class="anchor" href="#_process"></a>Process</h5>
<div class="paragraph">
<p><code>startStep(String)</code> starts a new sub routine.</p>
</div>
<div class="paragraph">
<p><code>stopStep()</code> stops the last sub routine</p>
</div>
</div>
<div class="sect4">
<h5 id="_log_messages"><a class="anchor" href="#_log_messages"></a>Log Messages</h5>
<div class="paragraph">
<p><code>logEvent(String)</code> logs a message inside a routine</p>
</div>
<div class="paragraph">
<p>When an action starts, a first process (the action) is automatically started.
It begins with the action and ends with success or error.
If no other progress change is reported during the execution of the action, a loader is rendered during the</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">.    My Action
..   My Action
[..] My Action
    .    Sub Routine
    ..   Sub Routine
    [ok] Sub Routine
[ok] My Action</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_recipes"><a class="anchor" href="#_creating_recipes"></a>Creating Recipes</h3>
<div class="paragraph">
<p>Recipes bundle a set of Actions for a migration.
They can be declared programmatically as Spring beans or declarative using yaml syntax.
The main difference is that yaml recipes can be provided to SBM without code changes on startup allowing to add new,
declarative recipes without recompilation while the bean definition is arguably easier to use.</p>
</div>
<div class="sect3">
<h4 id="_declarative_recipes"><a class="anchor" href="#_declarative_recipes"></a>Declarative recipes</h4>
<div class="paragraph">
<p>Declarative recipes must be placed under <code>src/main`resources/recipes</code>.<br>
See <a href="{repo}/blob/main/components/sbm-support-boot/src/main/resources/recipes/initialize-spring-boot-migration.yaml" target="_blank" rel="noopener">initialize-spring-boot-migration.yaml</a> for a recipe in YAML syntax</p>
</div>
</div>
<div class="sect3">
<h4 id="_recipe_beans"><a class="anchor" href="#_recipe_beans"></a>Recipe beans</h4>
<div class="paragraph">
<p>A recipe can be defined as Spring bean using @Bean annotated method, see <a href="{repo}/blob/main/components/sbm-recipes-mule-to-boot/src/main/java/org/springframework/sbm/mule/MigrateMuleToBoot.java" target="_blank" rel="noopener">MigrateMuleToBoot.java</a> for a recipe declared as Spring bean.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Remember to provide a description to all Actions to display the description to the user when the Action is applied.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_openrewrite_recipes"><a class="anchor" href="#_using_openrewrite_recipes"></a>Using OpenRewrite Recipes</h3>
<div class="sect3">
<h4 id="_programmatically"><a class="anchor" href="#_programmatically"></a>Programmatically</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ProjectContext context = ...
String annotationPattern = "@java.lang.Deprecated";
org.openrewrite.java.RemoveAnnotation rewriteRecipe = new RemoveAnnotation(annotationPattern);
context.getProjectJavaSources().apply(rewriteRecipe);
</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_in_sbm_yaml"><a class="anchor" href="#_in_sbm_yaml"></a>In SBM YAML</h4>
<div class="sect4">
<h5 id="_using_declarative_openrewrite_yaml"><a class="anchor" href="#_using_declarative_openrewrite_yaml"></a>Using Declarative OpenRewrite YAML</h5>
<div class="paragraph">
<p>Use <code>org.springframework.sbm.engine.recipe.OpenRewriteDeclarativeRecipeAdapter</code> to use embedded OpenRewrite YAML syntax in SBM YAML to run a declarative OpenRewrite recipe as SBM action.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">- name: test-recipe
  description: "Remove @Deprecated annotations"
  condition:
    type: org.springframework.sbm.common.migration.conditions.TrueCondition
  actions:
    - type: org.springframework.sbm.engine.recipe.OpenRewriteDeclarativeRecipeAdapter
      description: "Use a OpenRewrite recipe to remove @Deprecated annotations"
      openRewriteRecipe: |-
        type: specs.openrewrite.org/v1beta/recipe
        name: org.openrewrite.java.RemoveAnnotation
        displayName: "Remove @Deprecated annotation"
        description: "Remove @Deprecated annotation"
        recipeList:
          - org.openrewrite.java.RemoveAnnotation:
              annotationPattern: "@java.lang.Deprecated"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_by_name"><a class="anchor" href="#_by_name"></a>By Name</h5>
<div class="paragraph">
<p>Use <code>org.springframework.sbm.engine.recipe.OpenRewriteNamedRecipeAdapter</code> to run an OpenRewrite recipe by name as SBM action.
Here an OpenRewrite recipe with name <code>org.springframework.sbm.dummy.RemoveDeprecatedAnnotation</code> must exist on the classpath and will be executed as action in <code>test-recipe</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">- name: test-recipe
  description: "Remove @Deprecated annotations"
  condition:
    type: org.springframework.sbm.common.migration.conditions.TrueCondition
  actions:
    - type: org.springframework.sbm.engine.recipe.OpenRewriteNamedRecipeAdapter
      description: "Call a OpenRewrite recipe to remove @Deprecated annotations"
      openRewriteRecipeName: org.springframework.sbm.dummy.RemoveDeprecatedAnnotation</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_in_sbm_java_code"><a class="anchor" href="#_in_sbm_java_code"></a>In SBM Java code</h4>
<div class="sect4">
<h5 id="_using_declarative_openrewrite_yaml_2"><a class="anchor" href="#_using_declarative_openrewrite_yaml_2"></a>Using Declarative OpenRewrite YAML</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
public class SomeRecipe {

    @Bean
    Recipe someRecipe(RewriteRecipeLoader rewriteRecipeLoader, RewriteMigrationResultMerger resultMerger) {
        return Recipe.builder()
                ...
                .action(
                        OpenRewriteDeclarativeRecipeAdapter.builder()
                                .rewriteRecipeLoader(rewriteRecipeLoader)
                                .resultMerger(resultMerger)
                                .openRewriteRecipe(
                                    "type: specs.openrewrite.org/v1beta/recipe\n" +
                                    "name: org.openrewrite.java.RemoveAnnotation\n" +
                                    "displayName: \"Remove @Deprecated annotation\"\n" +
                                    "description: \"Remove @Deprecated annotation\"\n" +
                                    "recipeList:\n" +
                                    "  - org.openrewrite.java.RemoveAnnotation:\n" +
                                    "      annotationPattern: \"@java.lang.Deprecated\"\n"
                                )
                                .build())
                ...
                .build();
    }
}
</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_by_name_2"><a class="anchor" href="#_by_name_2"></a>By Name</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
public class SomeRecipe {

    @Bean
    Recipe someRecipe(RewriteRecipeLoader rewriteRecipeLoader, RewriteMigrationResultMerger resultMerger) {
        return Recipe.builder()
                ...
                .action(
                        OpenRewriteNamedRecipeAdapter.builder()
                                .rewriteRecipeLoader(rewriteRecipeLoader)
                                .resultMerger(resultMerger)
                                .openRewriteRecipeName(
                                    "org.springframework.sbm.dummy.RemoveDeprecatedAnnotation"
                                )
                                .build())
                ...
                .build();
    }
}
</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_condition"><a class="anchor" href="#_create_a_condition"></a>Create a Condition</h3>
<div class="paragraph">
<p>Every <code>Action</code> and every <code>Recipe</code> must have a <code>Condition</code> which defines if the <code>Recipe</code> or <code>Action</code> is applicable.
Therefore the <code>Condition</code> interface must be implemented which defines a <code>evaluate(ProjectContext)</code> method which must return true if the Recipe or Action is applicable and false otherwise.
A condition should only read from the <code>ProjectContext</code> and never modify the AST.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class MyCondition implements Condition {
    @Override
    public boolean evaluate(ProjectContext context) {
        // analyze ProjectContext to evaluate condition
    }
}
</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_single_and_multi_module_projects"><a class="anchor" href="#_single_and_multi_module_projects"></a>Single and Multi module projects</h3>
<div class="paragraph">
<p>Projects can come as single module or multi-module project.
Working with single module projects is significantly easier because only one <code>BuildFile</code> exists.
With multi-module projects the application modules play a central role and there must be means to
select a module.</p>
</div>
<div class="sect3">
<h4 id="_application_modules"><a class="anchor" href="#_application_modules"></a>Application Modules</h4>
<div class="paragraph">
<p>A common multi-module project has a root modules which consists of one or more child modules which again can consist of multiple child modules and so on.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The root module</p>
</li>
<li>
<p>The application module(s), bundle all modules of an application and define the composition of deployable artifact buulding a runnable application, e.g. a war module</p>
</li>
<li>
<p>The component module(s), define reusable components which are not deployable in isolation</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public void apply(ProjectContext context) {
    Modules modules = context.getModules();
    Module module = modules.getModule("path/of/module");
    boolean isMultiModule = modules.isMultiModuleProject();
    Module root = modules.getRootModule(); // type="pom" or type="ear"
    modules.getApplicationModules(); // type="war", containing "main" method
    modules.getComponentModules(); // type="jar" without main method

    List&lt;Module&gt; parentModules = module.getParentModules();
    List&lt;Module&gt; subModules = module.getSubModules();
}
</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_finding_the_module_containing_a_resource"><a class="anchor" href="#_finding_the_module_containing_a_resource"></a>Finding the <code>Module</code> containing a resource</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Only "Maven" <code>main</code> and <code>test</code> are used as source sets and any settings in the pom.xml or otherwise are ignored.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ProjectResource pr = ...
Optional&lt;Module&gt; module = context.getModules.findModuleContaining(pr.getAbsolutePath());
</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_buildfile_and_dependencies"><a class="anchor" href="#_buildfile_and_dependencies"></a>BuildFile and Dependencies</h3>
<div class="paragraph">
<p>The buildfiles of the scanned project are represented by <code>BuildFile</code>.
The <code>BuildFile</code> API offers methods to read and modify the buildfile.
<code>BuildFile</code>s can be retrieved through the <code>ProjectContext</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    // Retrieve the root build file
    BuildFile rootBuildFile = projectContext.getBuildFile();
</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_adding_a_dependency"><a class="anchor" href="#_adding_a_dependency"></a>Adding a Dependency</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public void apply(ProjectContext context) {
    // ...get buildFile for module
    BuildFile buildFile = context...
    Dependency dependency = Dependency.builder()
                                .groupId("...")
                                .artifactId("...")
                                .version("...")
                                .scope("test")
                                .build();
    buildFile.addDependency(dependency);
}
</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_removing_a_dependency"><a class="anchor" href="#_removing_a_dependency"></a>Removing a Dependency</h4>

</div>
<div class="sect3">
<h4 id="_adding_dependency_exclusion"><a class="anchor" href="#_adding_dependency_exclusion"></a>Adding Dependency Exclusion</h4>

</div>
</div>
<div class="sect2">
<h3 id="_migrating_java_code"><a class="anchor" href="#_migrating_java_code"></a>Migrating Java Code</h3>
<div class="sect3">
<h4 id="_access_all_javasources"><a class="anchor" href="#_access_all_javasources"></a>Access all JavaSources</h4>

</div>
<div class="sect3">
<h4 id="_adding_annotations"><a class="anchor" href="#_adding_annotations"></a>Adding annotations</h4>

</div>
<div class="sect3">
<h4 id="_removing_annotations"><a class="anchor" href="#_removing_annotations"></a>Removing annotations</h4>

</div>
<div class="sect3">
<h4 id="_modifying_annotations"><a class="anchor" href="#_modifying_annotations"></a>Modifying annotations</h4>

</div>
<div class="sect3">
<h4 id="_migrating_methods"><a class="anchor" href="#_migrating_methods"></a>Migrating Methods</h4>

</div>
<div class="sect3">
<h4 id="_add_a_new_javasource"><a class="anchor" href="#_add_a_new_javasource"></a>Add a new JavaSource</h4>
<div class="paragraph">
<p>A new <code>JavaSource</code> must be added to a <code>JavaSourceSet</code> of a given <code>ApplicationModule</code>.
The default <code>JavaSourceSet</code>s are 'main' (<code>src/main/java</code>) and 'test' (<code>src/test/java</code>).</p>
</div>
<div class="paragraph">
<p>Example: Adding a new Java class to the 'main' source set of an <code>ApplicationModule</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public void apply(ProjectContext context) {

    ApplicationModule targetModule = ... // retrieve target module

    String javaCode =
        "package com.example.foo;\n" +
        "public class Bar {}";

    Path projectRootDirectory = context.getProjectRootDirectory();

    targetModule.getMainJavaSourceSet().addJavaSource(projectRootDirectory, sourceFolder, src, packageName);
}
</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_openrewrite_recipe_and_visitor"><a class="anchor" href="#_openrewrite_recipe_and_visitor"></a>OpenRewrite Recipe and Visitor</h3>

</div>
<div class="sect2">
<h3 id="_use_freemarker_templates"><a class="anchor" href="#_use_freemarker_templates"></a>Use Freemarker templates</h3>
<div class="paragraph">
<p>Add this snippet to your Action to use freemarker</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class MyAction extends AbstractAction {

    @Autowired
    @JsonIgnore
    @Setter
    private Configuration configuration;

    // ...
}
</code></pre>
</div>
</div>
<div class="paragraph">
<p>and place your template under <code>src/main/resources/templates</code></p>
</div>
<div class="paragraph">
<p>Example: using Freemarker template in Action</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Map&lt;String, String&gt; params = new HashMap&lt;&gt;();
params.put("groupId", "com.example.change");
params.put("artifactId", projectName);
params.put("version", "0.1.0-SNAPSHOT");

StringWriter writer = new StringWriter();
try {
    Template template = configuration.getTemplate("minimal-pom-xml.ftl");
    template.process(params, writer);
} catch (TemplateException | IOException e) {
    throw new RuntimeException(e);
}
String src = writer.toString();
</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_migrate_multi_module_projects"><a class="anchor" href="#_migrate_multi_module_projects"></a>Migrate Multi Module Projects</h3>
<div class="sect3">
<h4 id="_access_a_modules_javasources"><a class="anchor" href="#_access_a_modules_javasources"></a>Access a Module&#8217;s JavaSources</h4>

</div>
</div>
<div class="sect2">
<h3 id="Specialized_Resources"><a class="anchor" href="#Specialized_Resources"></a>Specialized Resources</h3>
<div class="sect3">
<h4 id="_create_a_finder_to_access_other_resources"><a class="anchor" href="#_create_a_finder_to_access_other_resources"></a>Create a Finder to access other resources</h4>
<div class="paragraph">
<p>The <code>ProjectContext</code> only offers direct access to Java and BuildFile resources.
To access other resources the concept of <code>Finder</code>s exists.
A <code>Finder</code> implements the <code>ResourceFinder</code> interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface ProjectResourceFinder&lt;T&gt; {
    T apply(ProjectResourceSet projectResourceSet);
}
</code></pre>
</div>
</div>
<div class="paragraph">
<p>These <code>Finder</code>s can than be provided to the <code>search(&#8230;&#8203;)</code> method of <code>ProjectContext</code>.
The <code>ProjectContext</code> will provide the <code>ProjectResourceSet</code> to the <code>Finder</code> and the <code>Finder</code> can then filter/search</p>
</div>
</div>
<div class="sect3">
<h4 id="_manipulate_spring_boot_properties"><a class="anchor" href="#_manipulate_spring_boot_properties"></a>Manipulate Spring Boot properties</h4>

</div>
<div class="sect3">
<h4 id="_create_a_specialized_resource"><a class="anchor" href="#_create_a_specialized_resource"></a>Create a specialized Resource</h4>

</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-01-18 03:27:10 +0700
</div>
</div>
</div>
  </div>
</div>
</body>
</html>